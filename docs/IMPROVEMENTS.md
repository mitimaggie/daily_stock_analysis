# 脚本改进与提升建议

从**运行速度**、**Token 使用**、**分析逻辑**三方面整理的改进点，部分已落地，其余可按需实施。

---

## 一、运行速度

| 改进点 | 说明 | 状态 |
|--------|------|------|
| **大盘只拉一次** | 在 `run()` 阶段二开始前拉一次大盘快照，通过 `market_overview_override` 传给每只股，避免每只股都调 `get_market_snapshot()`（虽已有 60s 缓存，逻辑更清晰、日志更少） | ✅ 已做 |
| **舆情缓存** | 已有 `_get_cached_news_context` + `save_news_intel`，命中则跳过 2–5s 延迟与 Perplexity 调用 | ✅ 已有 |
| **预取缓存** | 阶段一写入 `_prefetch_cache`，阶段二用缓存 df/quote，避免重复拉行情 | ✅ 已有 |
| **阶段一延迟** | 串行时每只股后 `time.sleep(0.5)`，非交易时段可考虑缩短或做成可配置 | 可选 |
| **并发数** | 无搜索时可用 `--workers 2` 提速；有搜索时已限制为 2 防 429 | 按需 |

---

## 二、Token 与模型选择

| 改进点 | 说明 | 状态 |
|--------|------|------|
| **不做 input 截断 / output 上限** | 为保证 LLM 参考信息完整，技术面与舆情不截断，输出不设 max_tokens；成本通过「按场景选模型」控制 | 已采纳 |
| **2.5 Flash vs 3 Pro 分场景** | 见下方「Gemini 2.5 与 3 对比与分场景用法」 | ✅ 已做 |
| **Perplexity** | 已设 `max_tokens: 4000`，system_prompt 可按需再压缩 | 可选 |

### Gemini 2.5 Flash 与 3 Pro Preview 对比（简要）

| 维度 | 2.5 Flash | 3 Pro Preview |
|------|-----------|----------------|
| **价格（约）** | 输入 $0.30/M，输出 $2.50/M | 输入 $2.00/M，输出 $12.00/M |
| **相对成本** | 约 6–7 倍更便宜 | 主模型 |
| **速度** | 更快 | 较慢 |
| **能力** | 常规任务、结构化输出足够 | 复杂推理、长文分析更强 |

**分场景用法（已实现）**：命中舆情缓存时用 `GEMINI_MODEL_WHEN_CACHED`（默认 gemini-3-flash-preview，与主模型一致）；有新鲜舆情时用主模型 `GEMINI_MODEL`（默认 gemini-3-flash-preview）。可在 .env 中单独设置 `GEMINI_MODEL_WHEN_CACHED` 为其他模型（如 gemini-2.5-flash）以进一步省成本。

---

## 三、分析逻辑

| 改进点 | 说明 | 状态 |
|--------|------|------|
| **大盘滤网** | 已明确「大盘定仓位上限、个股 F10+技术面定买卖方向」，不替代个股逻辑 | ✅ 已有 |
| **F10 + 技术面** | 维度清晰；可在 prompt 中再强调「先定方向、再调仓位」 | 已有 |
| **简单输出模式** | 若只关心建议+评分，可做「简洁模式」：只要求 `operation_advice` + `sentiment_score`，减少输出 token | 可选 |
| **历史记忆** | 已有 `history_summary`，可考虑只取最近 1 次避免 prompt 过长 | 可选 |

---

## 四、已实现的代码改动摘要

1. **pipeline.run()**：阶段二开始前拉一次大盘，通过 `market_overview_override` 传入每只股。
2. **按场景选模型**：命中舆情缓存时用 `GEMINI_MODEL_WHEN_CACHED`（默认 3 Flash），有新鲜搜索时用主模型（默认 3 Flash）；可按需将 WHEN_CACHED 设为 2.5 Flash 进一步省成本。

---

## 五、可选后续

- **请求间隔**：若遇 429，可调大 `GEMINI_REQUEST_DELAY` 或分析间隔。
- **重试**：LLM 调用可加指数退避重试（Gemini/OpenAI 已有部分重试时可沿用）。
- **日志**：大盘注入等可改为只打一次（当前已通过「只拉一次大盘」减少重复日志）。

以上为当前建议与已做改动，后续可随使用情况继续迭代。
